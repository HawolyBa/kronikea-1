{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _objectWithoutProperties from \"@babel/runtime/helpers/esm/objectWithoutProperties\";\nimport _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport { db, auth, storage } from \"../fbConfig\";\nimport { types } from \"../../utils/constants\";\nimport firebase from \"firebase/app\";\nimport { message } from \"antd\";\nexport var log_in = function log_in(email, password) {\n  return function (dispatch) {\n    console.log(email, password);\n    auth.signInWithEmailAndPassword(email, password);\n  };\n};\nexport var getProfile = function getProfile(id) {\n  return function (dispatch) {\n    db.collection(\"users\").doc(id ? id : auth.currentUser.uid).onSnapshot(function (doc) {\n      return dispatch({\n        type: types.GET_PROFILE,\n        payload: _objectSpread({\n          id: doc.id\n        }, doc.data())\n      });\n    });\n  };\n};\nexport var getFavoriteAuthors = function getFavoriteAuthors(id) {\n  return function (dispatch) {\n    var addedOn;\n    var userId = id ? id : auth.currentUser.uid;\n    db.collection(\"usersLikes\").where(\"senderId\", \"==\", userId).get().then(function (docs) {\n      var favArr = [];\n      docs.forEach(function (doc) {\n        addedOn = doc.data().createdAt;\n        favArr = [].concat(_toConsumableArray(favArr), [doc.data().recipient]);\n      });\n      return favArr;\n    }).then(function (users) {\n      var result = users.map(function (user) {\n        return db.collection(\"users\").doc(user).get();\n      });\n      Promise.all(result).then(function (res) {\n        var favUsers = [];\n        res.forEach(function (doc) {\n          return favUsers = [].concat(_toConsumableArray(favUsers), [_objectSpread({\n            addedOn: addedOn,\n            id: doc.id\n          }, doc.data())]);\n        });\n        dispatch({\n          type: types.GET_FAVORITE_AUTHORS,\n          payload: favUsers\n        });\n      });\n    });\n  };\n};\nexport var getFollowers = function getFollowers(id) {\n  return function (dispatch) {\n    var addedOn;\n    var userId = id ? id : auth.currentUser.uid;\n    db.collection(\"usersLikes\").where(\"recipient\", \"==\", userId).get().then(function (docs) {\n      var favArr = [];\n      docs.forEach(function (doc) {\n        addedOn = doc.data().createdAt;\n        favArr = [].concat(_toConsumableArray(favArr), [doc.data().senderId]);\n      });\n      return favArr;\n    }).then(function (users) {\n      var result = users.map(function (user) {\n        return db.collection(\"users\").doc(user).get();\n      });\n      Promise.all(result).then(function (res) {\n        var favUsers = [];\n        res.forEach(function (doc) {\n          return favUsers = [].concat(_toConsumableArray(favUsers), [_objectSpread({\n            addedOn: addedOn,\n            id: doc.id\n          }, doc.data())]);\n        });\n        dispatch({\n          type: types.GET_FOLLOWERS,\n          payload: favUsers\n        });\n      });\n    });\n  };\n};\nexport var getIsFollowing = function getIsFollowing(userId) {\n  return function (dispatch) {\n    if (auth.currentUser) {\n      db.collection(\"usersLikes\").where(\"recipient\", \"==\", userId).where(\"senderId\", \"==\", auth.currentUser.uid).onSnapshot(function (snapshot) {\n        var answer = snapshot.docs.length > 0 ? true : false;\n        return dispatch({\n          type: types.IS_FOLLOWING,\n          payload: answer\n        });\n      });\n    }\n  };\n};\nexport var followUser = function followUser(id, isFavorite, newFollower) {\n  return function (dispatch) {\n    if (isFavorite) return message.warning(\"You are already following this user\");\n    if (!auth.currentUser) return message.error(\"You need to be logged in to follow users\");\n    if (!auth.currentUser.emailVerified) return message.error(\"You need to verify your email first\");\n    db.collection(\"usersLikes\").add({\n      sender: newFollower.username,\n      senderId: newFollower.uid,\n      recipient: id,\n      createdAt: firebase.firestore.FieldValue.serverTimestamp()\n    }).then(function () {\n      return message.success(\"You are now following this user\");\n    })[\"catch\"](function (err) {\n      return message.error(\"There has been a problem\");\n    });\n  };\n};\nexport var unfollowUser = function unfollowUser(id, isFavorite) {\n  return function (dispatch) {\n    if (!isFavorite) return message.warning(\"You are not following this user yet\");\n    db.collection(\"usersLikes\").where(\"recipient\", \"==\", id).where(\"senderId\", \"==\", auth.currentUser.uid).get().then(function (data) {\n      return db.collection(\"usersLikes\").doc(data.docs[0].id)[\"delete\"]();\n    }).then(function () {\n      return message.success(\"User successfully unfollowed\");\n    })[\"catch\"](function (err) {\n      return message.error(\"There has been a problem\");\n    });\n  };\n};\nexport var changeProfile = function changeProfile(data, setOpen, username, userImage) {\n  return function (dispatch) {\n    var batch = db.batch();\n\n    var newPassword = data.newPassword,\n        actualPassword = data.actualPassword,\n        newInfo = _objectWithoutProperties(data, [\"newPassword\", \"actualPassword\"]);\n\n    var imageName = \"\".concat(auth.currentUser.uid, \"_\").concat(newInfo.username); // STORIES, CHAPTERS, CHARACTERS & COMMENTS QUERIES\n\n    var userStoriesQuery = db.collection(\"stories\").where(\"authorId\", \"==\", auth.currentUser.uid).get();\n    var userChaptersQuery = db.collection(\"chapters\").where(\"authorId\", \"==\", auth.currentUser.uid).get();\n    var userCharactersQuery = db.collection(\"characters\").where(\"authorId\", \"==\", auth.currentUser.uid).get();\n    var userCommentsQuery = db.collection(\"comments\").where(\"userId\", \"==\", auth.currentUser.uid).get();\n\n    var batchUpdateAll = function batchUpdateAll(queries) {\n      Promise.all(queries).then(function (res) {\n        res[0].forEach(function (story) {\n          batch.update(db.collection(\"stories\").doc(story.id), {\n            userImage: url,\n            authorName: data.username\n          });\n        });\n        res[1].forEach(function (chap) {\n          batch.update(db.collection(\"chapters\").doc(chap.id), {\n            userImage: url,\n            authorName: data.username\n          });\n        });\n        res[2].forEach(function (_char) {\n          batch.update(db.collection(\"characters\").doc(_char.id), {\n            userImage: url,\n            authorName: data.username\n          });\n        });\n        res[3].forEach(function (_char2) {\n          batch.update(db.collection(\"comments\").doc(_char2.id), {\n            userImage: url,\n            username: data.username\n          });\n        });\n      });\n    };\n\n    if (newPassword) {\n      auth.currentUser.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, actualPassword)).then(function () {\n        return auth.currentUser.updatePassword(newPassword);\n      }).then( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                if (!(typeof newInfo.image === \"object\")) {\n                  _context2.next = 4;\n                  break;\n                }\n\n                storage.ref(\"\".concat(auth.currentUser.uid, \"/\").concat(imageName)).put(newInfo.image).then(function () {\n                  return storage.ref(\"\".concat(auth.currentUser.uid, \"/\").concat(imageName)).getDownloadURL();\n                }).then( /*#__PURE__*/function () {\n                  var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(url) {\n                    return _regeneratorRuntime.wrap(function _callee$(_context) {\n                      while (1) {\n                        switch (_context.prev = _context.next) {\n                          case 0:\n                            imageUrl = url;\n                            batch.update(db.collection(\"users\").doc(auth.currentUser.uid), _objectSpread(_objectSpread({}, newInfo), {}, {\n                              image: imageUrl\n                            }));\n                            _context.next = 4;\n                            return batchUpdateAll([userStoriesQuery, userChaptersQuery, userCharactersQuery, userCommentsQuery]);\n\n                          case 4:\n                            batch.commit().then(function () {\n                              return console.log(\"all good\");\n                            });\n\n                          case 5:\n                          case \"end\":\n                            return _context.stop();\n                        }\n                      }\n                    }, _callee);\n                  }));\n\n                  return function (_x) {\n                    return _ref2.apply(this, arguments);\n                  };\n                }());\n                _context2.next = 8;\n                break;\n\n              case 4:\n                batch.update(db.collection(\"users\").doc(auth.currentUser.uid), _objectSpread({}, newInfo));\n                _context2.next = 7;\n                return batchUpdateAll([userStoriesQuery, userChaptersQuery, userCharactersQuery, userCommentsQuery]);\n\n              case 7:\n                batch.commit().then(function () {\n                  return console.log(\"all good\");\n                });\n\n              case 8:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      })));\n    } else {\n      if (typeof newInfo.image === \"object\") {\n        storage.ref(\"\".concat(auth.currentUser.uid, \"/\").concat(imageName)).put(newInfo.image).then(function () {\n          return storage.ref(\"\".concat(auth.currentUser.uid, \"/\").concat(imageName)).getDownloadURL();\n        }).then( /*#__PURE__*/function () {\n          var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(url) {\n            return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n              while (1) {\n                switch (_context3.prev = _context3.next) {\n                  case 0:\n                    imageUrl = url;\n                    batch.update(db.collection(\"users\").doc(auth.currentUser.uid), _objectSpread(_objectSpread({}, newInfo), {}, {\n                      image: imageUrl\n                    }));\n                    _context3.next = 4;\n                    return batchUpdateAll([userStoriesQuery, userChaptersQuery, userCharactersQuery, userCommentsQuery]);\n\n                  case 4:\n                    batch.commit().then(function () {\n                      return console.log(\"all good\");\n                    });\n\n                  case 5:\n                  case \"end\":\n                    return _context3.stop();\n                }\n              }\n            }, _callee3);\n          }));\n\n          return function (_x2) {\n            return _ref3.apply(this, arguments);\n          };\n        }());\n      } else {\n        batch.update(db.collection(\"users\").doc(auth.currentUser.uid), _objectSpread({}, newInfo));\n        batchUpdateAll([userStoriesQuery, userChaptersQuery, userCharactersQuery, userCommentsQuery]);\n        batch.commit().then(function () {\n          return console.log(\"all good\");\n        });\n      }\n    } //   const reauthenticate = (currentPassword) => {\n    //   const user = auth.currentUser;\n    //   const cred = ;\n    //   return user.reauthenticateWithCredential(cred);\n    // };\n    // const batch = db.batch();\n    // const { newPassword, actualPassword, ...newInfo } = data;\n    // const imageName = `${auth.currentUser.uid}_${data.username}`;\n    // let imageUrl = \"\";\n    // const userStoriesQuery = db\n    //   .collection(\"stories\")\n    //   .where(\"authorId\", \"==\", auth.currentUser.uid)\n    //   .get();\n    // const userChaptersQuery = db\n    //   .collection(\"chapters\")\n    //   .where(\"authorId\", \"==\", auth.currentUser.uid)\n    //   .get();\n    // const userCharactersQuery = db\n    //   .collection(\"characters\")\n    //   .where(\"authorId\", \"==\", auth.currentUser.uid)\n    //   .get();\n    // const userCommentsQuery = db\n    //   .collection(\"comments\")\n    //   .where(\"userId\", \"==\", auth.currentUser.uid)\n    //   .get();\n    // Promise.all([\n    //   userStoriesQuery,\n    //   userChaptersQuery,\n    //   userCharactersQuery,\n    //   userCommentsQuery,\n    // ]).then((res) => {\n    //   res[0].forEach((story) => {\n    //     batch.update(db.collection(\"stories\").doc(story.id), {\n    //       userImage: url,\n    //       authorName: data.username,\n    //     });\n    //   });\n    //   res[1].forEach((chap) => {\n    //     batch.update(db.collection(\"chapters\").doc(chap.id), {\n    //       userImage: url,\n    //       authorName: data.username,\n    //     });\n    //   });\n    //   res[2].forEach((char) => {\n    //     batch.update(db.collection(\"characters\").doc(char.id), {\n    //       userImage: url,\n    //       authorName: data.username,\n    //     });\n    //   });\n    //   res[3].forEach((char) => {\n    //     batch.update(db.collection(\"comments\").doc(char.id), {\n    //       userImage: url,\n    //       username: data.username,\n    //     });\n    //   });\n    // });\n    // // UPDATE l'USER\n    // if (typeof data.image === \"object\") {\n    //   storage\n    //     .ref(`${auth.currentUser.uid}/${imageName}`)\n    //     .put(data.image)\n    //     .then(() => {\n    //       return storage\n    //         .ref(`${auth.currentUser.uid}/${imageName}`)\n    //         .getDownloadURL();\n    //     })\n    //     .then((url) => {\n    //       imageUrl = url;\n    //       db.update(db.collection(\"users\").doc(auth.currentUser.uid), {\n    //         ...newInfo,\n    //         image: imageUrl,\n    //       });\n    //     });\n    // } else {\n    //   db.update(db.collection(\"users\").doc(auth.currentUser.uid), {\n    //     ...newInfo,\n    //   });\n    // }\n    // // UPDATE LE MOT DE PASSE\n    // if (newPassword) {\n    //   auth.currentUser\n    //     .reauthenticateWithCredential(\n    //       firebase.auth.EmailAuthProvider.credential(user.email, currentPassword)\n    //     )\n    //     .then(() => {\n    //       return user.updatePassword(newPassword);\n    //     });\n    // }\n    // // UPDATE LES TORIES, CHARACTERS & COMMENTS SI BESOIN\n    // // if()\n    // if (newPassword) {\n    //   reauthenticate(actualPassword)\n    //     .then(() => {\n    //       const user = auth.currentUser;\n    //       user.updatePassword(newPassword).then(() => {\n    //         if (typeof data.image === \"object\") {\n    //           storage\n    //             .ref(`${auth.currentUser.uid}/${imageName}`)\n    //             .put(data.image)\n    //             .then(() => {\n    //               return storage\n    //                 .ref(auth.currentUser.uid)\n    //                 .child(imageName)\n    //                 .getDownloadURL();\n    //             })\n    //             .then((url) => {\n    //               if (data.username !== username || data.image !== userImage) {\n    //                 batch.update(\n    //                   db.collection(\"users\").doc(auth.currentUser.uid),\n    //                   {\n    //                     image: url,\n    //                     ...newInfo,\n    //                   }\n    //                 );\n    //                 batch\n    //                   .commit()\n    //                   .then(() => {\n    //                     setOpen(false);\n    //                     message.success(\n    //                       \"Your profile has been successfully updated\"\n    //                     );\n    //                   })\n    //                   .catch((error) => {\n    //                     message.error(error.message);\n    //                   });\n    //               } else {\n    //                 batch.update(\n    //                   db.collection(\"users\").doc(auth.currentUser.uid),\n    //                   {\n    //                     image: url,\n    //                     ...newInfo,\n    //                   }\n    //                 );\n    //                 batch\n    //                   .commit()\n    //                   .then(() => {\n    //                     setOpen(false);\n    //                     message.success(\n    //                       \"Your profile has been successfully updated\"\n    //                     );\n    //                   })\n    //                   .catch((error) => {\n    //                     message.error(error.message);\n    //                   });\n    //               }\n    //             });\n    //         } else {\n    //           if (data.username !== username) {\n    //             Promise.all([\n    //               userStoriesQuery,\n    //               userChaptersQuery,\n    //               userCharactersQuery,\n    //               userCommentsQuery,\n    //             ]).then((res) => {\n    //               res[0].forEach((story) => {\n    //                 batch.update(db.collection(\"stories\").doc(story.id), {\n    //                   authorName: data.username,\n    //                 });\n    //               });\n    //               res[0].forEach((chap) => {\n    //                 batch.update(db.collection(\"chapters\").doc(chap.id), {\n    //                   authorName: data.username,\n    //                 });\n    //               });\n    //               res[0].forEach((char) => {\n    //                 batch.update(db.collection(\"characters\").doc(char.id), {\n    //                   authorName: data.username,\n    //                 });\n    //               });\n    //               res[0].forEach((char) => {\n    //                 batch.update(db.collection(\"comments\").doc(char.id), {\n    //                   username: data.username,\n    //                 });\n    //               });\n    //             });\n    //             batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\n    //               ...newInfo,\n    //             });\n    //           } else {\n    //             batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\n    //               ...newInfo,\n    //             });\n    //             batch\n    //               .commit()\n    //               .then(() => {\n    //                 setOpen(false);\n    //                 message.success(\"Your profile has been successfully updated\");\n    //               })\n    //               .catch((error) => {\n    //                 message.error(error.message);\n    //               });\n    //           }\n    //         }\n    //       });\n    //     })\n    //     .catch((err) => {\n    //       message.error(err.message);\n    //     });\n    // } else {\n    //   if (typeof data.image === \"object\") {\n    //     storage\n    //       .ref(`${auth.currentUser.uid}/${imageName}`)\n    //       .put(data.image)\n    //       .then(() => {\n    //         return storage\n    //           .ref(auth.currentUser.uid)\n    //           .child(imageName)\n    //           .getDownloadURL();\n    //       })\n    //       .then((url) => {\n    //         if (data.username !== username || data.image !== userImage) {\n    //           Promise.all([\n    //             userStoriesQuery,\n    //             userChaptersQuery,\n    //             userCharactersQuery,\n    //             userCommentsQuery,\n    //           ]).then((res) => {\n    //             res[0].forEach((story) => {\n    //               batch.update(db.collection(\"stories\").doc(story.id), {\n    //                 userImage: url,\n    //                 authorName: data.username,\n    //               });\n    //             });\n    //             res[1].forEach((chap) => {\n    //               batch.update(db.collection(\"chapters\").doc(chap.id), {\n    //                 userImage: url,\n    //                 authorName: data.username,\n    //               });\n    //             });\n    //             res[2].forEach((char) => {\n    //               batch.update(db.collection(\"characters\").doc(char.id), {\n    //                 userImage: url,\n    //                 authorName: data.username,\n    //               });\n    //             });\n    //             res[3].forEach((char) => {\n    //               batch.update(db.collection(\"comments\").doc(char.id), {\n    //                 userImage: url,\n    //                 username: data.username,\n    //               });\n    //             });\n    //           });\n    //           batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\n    //             ...newInfo,\n    //             image: url,\n    //           });\n    //           batch\n    //             .commit()\n    //             .then(() => {\n    //               setOpen(false);\n    //               message.success(\"Your profile has been successfully updated\");\n    //             })\n    //             .catch((error) => {\n    //               message.error(error.message);\n    //             });\n    //         } else {\n    //           batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\n    //             ...newInfo,\n    //           });\n    //           batch\n    //             .commit()\n    //             .then(() => {\n    //               setOpen(false);\n    //               message.success(\"Your profile has been successfully updated\");\n    //             })\n    //             .catch((error) => {\n    //               message.error(error.message);\n    //             });\n    //         }\n    //       });\n    //   } else {\n    //     if (data.username !== username) {\n    //       Promise.all([\n    //         userStoriesQuery,\n    //         userChaptersQuery,\n    //         userCharactersQuery,\n    //         userCommentsQuery,\n    //       ]).then((res) => {\n    //         res[0].forEach((story) => {\n    //           batch.update(db.collection(\"stories\").doc(story.id), {\n    //             authorName: data.username,\n    //           });\n    //         });\n    //         res[1].forEach((chap) => {\n    //           batch.update(db.collection(\"chapters\").doc(chap.id), {\n    //             authorName: data.username,\n    //           });\n    //         });\n    //         res[2].forEach((char) => {\n    //           batch.update(db.collection(\"characters\").doc(char.id), {\n    //             authorName: data.username,\n    //           });\n    //         });\n    //         res[3].forEach((char) => {\n    //           batch.update(db.collection(\"comments\").doc(char.id), {\n    //             username: data.username,\n    //           });\n    //         });\n    //         batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\n    //           ...newInfo,\n    //         });\n    //         batch\n    //           .commit()\n    //           .then(() => {\n    //             setOpen(false);\n    //             message.success(\"Your profile has been successfully updated\");\n    //           })\n    //           .catch((error) => {\n    //             message.error(error.message);\n    //           });\n    //       });\n    //     } else {\n    //       batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\n    //         ...newInfo,\n    //       });\n    //       batch\n    //         .commit()\n    //         .then(() => {\n    //           setOpen(false);\n    //           message.success(\"Your profile has been successfully updated\");\n    //         })\n    //         .catch((error) => {\n    //           message.error(error.message);\n    //         });\n    //     }\n    //   }\n    // }\n\n  };\n};","map":{"version":3,"sources":["C:/Users/Utilisateur/Documents/CODE/kronikea-master/redux/actions/userActions.js"],"names":["db","auth","storage","types","firebase","message","log_in","email","password","dispatch","console","log","signInWithEmailAndPassword","getProfile","id","collection","doc","currentUser","uid","onSnapshot","type","GET_PROFILE","payload","data","getFavoriteAuthors","addedOn","userId","where","get","then","docs","favArr","forEach","createdAt","recipient","users","result","map","user","Promise","all","res","favUsers","GET_FAVORITE_AUTHORS","getFollowers","senderId","GET_FOLLOWERS","getIsFollowing","snapshot","answer","length","IS_FOLLOWING","followUser","isFavorite","newFollower","warning","error","emailVerified","add","sender","username","firestore","FieldValue","serverTimestamp","success","err","unfollowUser","changeProfile","setOpen","userImage","batch","newPassword","actualPassword","newInfo","imageName","userStoriesQuery","userChaptersQuery","userCharactersQuery","userCommentsQuery","batchUpdateAll","queries","story","update","url","authorName","chap","char","reauthenticateWithCredential","EmailAuthProvider","credential","updatePassword","image","ref","put","getDownloadURL","imageUrl","commit"],"mappings":"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,CAAalF,EAAE,CAACe,UAAH,CAAc,OAAd,EAAuBC,GAAvB,CAA2Bf,IAAI,CAACgB,WAAL,CAAiBC,GAA5C,CAAb,oBACKuD,OADL;AAGAM,QAAAA,cAAc,CAAC,CACbJ,gBADa,EAEbC,iBAFa,EAGbC,mBAHa,EAIbC,iBAJa,CAAD,CAAd;AAMAR,QAAAA,KAAK,CAAC0B,MAAN,GAAenE,IAAf,CAAoB;AAAA,iBAAMnB,OAAO,CAACC,GAAR,CAAY,UAAZ,CAAN;AAAA,SAApB;AACD;AACF,KAxIE,CA0IH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACD,GAnd4B;AAAA,CAAtB","sourcesContent":["import { db, auth, storage } from \"../fbConfig\";\r\nimport { types } from \"../../utils/constants\";\r\nimport firebase from \"firebase/app\";\r\nimport { message } from \"antd\";\r\n\r\nexport const log_in = (email, password) => (dispatch) => {\r\n  console.log(email, password);\r\n  auth.signInWithEmailAndPassword(email, password);\r\n};\r\n\r\nexport const getProfile = (id) => (dispatch) => {\r\n  db.collection(\"users\")\r\n    .doc(id ? id : auth.currentUser.uid)\r\n    .onSnapshot((doc) => {\r\n      return dispatch({\r\n        type: types.GET_PROFILE,\r\n        payload: { id: doc.id, ...doc.data() },\r\n      });\r\n    });\r\n};\r\n\r\nexport const getFavoriteAuthors = (id) => (dispatch) => {\r\n  let addedOn;\r\n  const userId = id ? id : auth.currentUser.uid;\r\n  db.collection(\"usersLikes\")\r\n    .where(\"senderId\", \"==\", userId)\r\n    .get()\r\n    .then((docs) => {\r\n      let favArr = [];\r\n      docs.forEach((doc) => {\r\n        addedOn = doc.data().createdAt;\r\n        favArr = [...favArr, doc.data().recipient];\r\n      });\r\n      return favArr;\r\n    })\r\n    .then((users) => {\r\n      const result = users.map((user) =>\r\n        db.collection(\"users\").doc(user).get()\r\n      );\r\n      Promise.all(result).then((res) => {\r\n        let favUsers = [];\r\n        res.forEach(\r\n          (doc) =>\r\n            (favUsers = [...favUsers, { addedOn, id: doc.id, ...doc.data() }])\r\n        );\r\n        dispatch({\r\n          type: types.GET_FAVORITE_AUTHORS,\r\n          payload: favUsers,\r\n        });\r\n      });\r\n    });\r\n};\r\n\r\nexport const getFollowers = (id) => (dispatch) => {\r\n  let addedOn;\r\n  const userId = id ? id : auth.currentUser.uid;\r\n  db.collection(\"usersLikes\")\r\n    .where(\"recipient\", \"==\", userId)\r\n    .get()\r\n    .then((docs) => {\r\n      let favArr = [];\r\n      docs.forEach((doc) => {\r\n        addedOn = doc.data().createdAt;\r\n        favArr = [...favArr, doc.data().senderId];\r\n      });\r\n      return favArr;\r\n    })\r\n    .then((users) => {\r\n      const result = users.map((user) =>\r\n        db.collection(\"users\").doc(user).get()\r\n      );\r\n      Promise.all(result).then((res) => {\r\n        let favUsers = [];\r\n        res.forEach(\r\n          (doc) =>\r\n            (favUsers = [...favUsers, { addedOn, id: doc.id, ...doc.data() }])\r\n        );\r\n        dispatch({\r\n          type: types.GET_FOLLOWERS,\r\n          payload: favUsers,\r\n        });\r\n      });\r\n    });\r\n};\r\n\r\nexport const getIsFollowing = (userId) => (dispatch) => {\r\n  if (auth.currentUser) {\r\n    db.collection(\"usersLikes\")\r\n      .where(\"recipient\", \"==\", userId)\r\n      .where(\"senderId\", \"==\", auth.currentUser.uid)\r\n      .onSnapshot((snapshot) => {\r\n        const answer = snapshot.docs.length > 0 ? true : false;\r\n        return dispatch({ type: types.IS_FOLLOWING, payload: answer });\r\n      });\r\n  }\r\n};\r\n\r\nexport const followUser = (id, isFavorite, newFollower) => (dispatch) => {\r\n  if (isFavorite) return message.warning(\"You are already following this user\");\r\n  if (!auth.currentUser)\r\n    return message.error(\"You need to be logged in to follow users\");\r\n  if (!auth.currentUser.emailVerified)\r\n    return message.error(\"You need to verify your email first\");\r\n\r\n  db.collection(\"usersLikes\")\r\n    .add({\r\n      sender: newFollower.username,\r\n      senderId: newFollower.uid,\r\n      recipient: id,\r\n      createdAt: firebase.firestore.FieldValue.serverTimestamp(),\r\n    })\r\n    .then(() => message.success(\"You are now following this user\"))\r\n    .catch((err) => message.error(\"There has been a problem\"));\r\n};\r\n\r\nexport const unfollowUser = (id, isFavorite) => (dispatch) => {\r\n  if (!isFavorite)\r\n    return message.warning(\"You are not following this user yet\");\r\n\r\n  db.collection(\"usersLikes\")\r\n    .where(\"recipient\", \"==\", id)\r\n    .where(\"senderId\", \"==\", auth.currentUser.uid)\r\n    .get()\r\n    .then((data) => {\r\n      return db.collection(\"usersLikes\").doc(data.docs[0].id).delete();\r\n    })\r\n    .then(() => message.success(\"User successfully unfollowed\"))\r\n    .catch((err) => message.error(\"There has been a problem\"));\r\n};\r\n\r\nexport const changeProfile = (data, setOpen, username, userImage) => (\r\n  dispatch\r\n) => {\r\n  const batch = db.batch();\r\n  const { newPassword, actualPassword, ...newInfo } = data;\r\n  const imageName = `${auth.currentUser.uid}_${newInfo.username}`;\r\n\r\n  // STORIES, CHAPTERS, CHARACTERS & COMMENTS QUERIES\r\n  const userStoriesQuery = db\r\n    .collection(\"stories\")\r\n    .where(\"authorId\", \"==\", auth.currentUser.uid)\r\n    .get();\r\n  const userChaptersQuery = db\r\n    .collection(\"chapters\")\r\n    .where(\"authorId\", \"==\", auth.currentUser.uid)\r\n    .get();\r\n  const userCharactersQuery = db\r\n    .collection(\"characters\")\r\n    .where(\"authorId\", \"==\", auth.currentUser.uid)\r\n    .get();\r\n  const userCommentsQuery = db\r\n    .collection(\"comments\")\r\n    .where(\"userId\", \"==\", auth.currentUser.uid)\r\n    .get();\r\n\r\n  const batchUpdateAll = (queries) => {\r\n    Promise.all(queries).then((res) => {\r\n      res[0].forEach((story) => {\r\n        batch.update(db.collection(\"stories\").doc(story.id), {\r\n          userImage: url,\r\n          authorName: data.username,\r\n        });\r\n      });\r\n      res[1].forEach((chap) => {\r\n        batch.update(db.collection(\"chapters\").doc(chap.id), {\r\n          userImage: url,\r\n          authorName: data.username,\r\n        });\r\n      });\r\n      res[2].forEach((char) => {\r\n        batch.update(db.collection(\"characters\").doc(char.id), {\r\n          userImage: url,\r\n          authorName: data.username,\r\n        });\r\n      });\r\n      res[3].forEach((char) => {\r\n        batch.update(db.collection(\"comments\").doc(char.id), {\r\n          userImage: url,\r\n          username: data.username,\r\n        });\r\n      });\r\n    });\r\n  };\r\n\r\n  if (newPassword) {\r\n    auth.currentUser\r\n      .reauthenticateWithCredential(\r\n        firebase.auth.EmailAuthProvider.credential(\r\n          auth.currentUser.email,\r\n          actualPassword\r\n        )\r\n      )\r\n      .then(() => {\r\n        return auth.currentUser.updatePassword(newPassword);\r\n      })\r\n      .then(async () => {\r\n        if (typeof newInfo.image === \"object\") {\r\n          storage\r\n            .ref(`${auth.currentUser.uid}/${imageName}`)\r\n            .put(newInfo.image)\r\n            .then(() => {\r\n              return storage\r\n                .ref(`${auth.currentUser.uid}/${imageName}`)\r\n                .getDownloadURL();\r\n            })\r\n            .then(async (url) => {\r\n              imageUrl = url;\r\n              batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n                ...newInfo,\r\n                image: imageUrl,\r\n              });\r\n              await batchUpdateAll([\r\n                userStoriesQuery,\r\n                userChaptersQuery,\r\n                userCharactersQuery,\r\n                userCommentsQuery,\r\n              ]);\r\n              batch.commit().then(() => console.log(\"all good\"));\r\n            });\r\n        } else {\r\n          batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n            ...newInfo,\r\n          });\r\n          await batchUpdateAll([\r\n            userStoriesQuery,\r\n            userChaptersQuery,\r\n            userCharactersQuery,\r\n            userCommentsQuery,\r\n          ]);\r\n          batch.commit().then(() => console.log(\"all good\"));\r\n        }\r\n      });\r\n  } else {\r\n    if (typeof newInfo.image === \"object\") {\r\n      storage\r\n        .ref(`${auth.currentUser.uid}/${imageName}`)\r\n        .put(newInfo.image)\r\n        .then(() => {\r\n          return storage\r\n            .ref(`${auth.currentUser.uid}/${imageName}`)\r\n            .getDownloadURL();\r\n        })\r\n        .then(async (url) => {\r\n          imageUrl = url;\r\n          batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n            ...newInfo,\r\n            image: imageUrl,\r\n          });\r\n          await batchUpdateAll([\r\n            userStoriesQuery,\r\n            userChaptersQuery,\r\n            userCharactersQuery,\r\n            userCommentsQuery,\r\n          ]);\r\n          batch.commit().then(() => console.log(\"all good\"));\r\n        });\r\n    } else {\r\n      batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n        ...newInfo,\r\n      });\r\n      batchUpdateAll([\r\n        userStoriesQuery,\r\n        userChaptersQuery,\r\n        userCharactersQuery,\r\n        userCommentsQuery,\r\n      ]);\r\n      batch.commit().then(() => console.log(\"all good\"));\r\n    }\r\n  }\r\n\r\n  //   const reauthenticate = (currentPassword) => {\r\n  //   const user = auth.currentUser;\r\n  //   const cred = ;\r\n  //   return user.reauthenticateWithCredential(cred);\r\n  // };\r\n  // const batch = db.batch();\r\n  // const { newPassword, actualPassword, ...newInfo } = data;\r\n  // const imageName = `${auth.currentUser.uid}_${data.username}`;\r\n  // let imageUrl = \"\";\r\n  // const userStoriesQuery = db\r\n  //   .collection(\"stories\")\r\n  //   .where(\"authorId\", \"==\", auth.currentUser.uid)\r\n  //   .get();\r\n  // const userChaptersQuery = db\r\n  //   .collection(\"chapters\")\r\n  //   .where(\"authorId\", \"==\", auth.currentUser.uid)\r\n  //   .get();\r\n  // const userCharactersQuery = db\r\n  //   .collection(\"characters\")\r\n  //   .where(\"authorId\", \"==\", auth.currentUser.uid)\r\n  //   .get();\r\n  // const userCommentsQuery = db\r\n  //   .collection(\"comments\")\r\n  //   .where(\"userId\", \"==\", auth.currentUser.uid)\r\n  //   .get();\r\n  // Promise.all([\r\n  //   userStoriesQuery,\r\n  //   userChaptersQuery,\r\n  //   userCharactersQuery,\r\n  //   userCommentsQuery,\r\n  // ]).then((res) => {\r\n  //   res[0].forEach((story) => {\r\n  //     batch.update(db.collection(\"stories\").doc(story.id), {\r\n  //       userImage: url,\r\n  //       authorName: data.username,\r\n  //     });\r\n  //   });\r\n  //   res[1].forEach((chap) => {\r\n  //     batch.update(db.collection(\"chapters\").doc(chap.id), {\r\n  //       userImage: url,\r\n  //       authorName: data.username,\r\n  //     });\r\n  //   });\r\n  //   res[2].forEach((char) => {\r\n  //     batch.update(db.collection(\"characters\").doc(char.id), {\r\n  //       userImage: url,\r\n  //       authorName: data.username,\r\n  //     });\r\n  //   });\r\n  //   res[3].forEach((char) => {\r\n  //     batch.update(db.collection(\"comments\").doc(char.id), {\r\n  //       userImage: url,\r\n  //       username: data.username,\r\n  //     });\r\n  //   });\r\n  // });\r\n  // // UPDATE l'USER\r\n  // if (typeof data.image === \"object\") {\r\n  //   storage\r\n  //     .ref(`${auth.currentUser.uid}/${imageName}`)\r\n  //     .put(data.image)\r\n  //     .then(() => {\r\n  //       return storage\r\n  //         .ref(`${auth.currentUser.uid}/${imageName}`)\r\n  //         .getDownloadURL();\r\n  //     })\r\n  //     .then((url) => {\r\n  //       imageUrl = url;\r\n  //       db.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n  //         ...newInfo,\r\n  //         image: imageUrl,\r\n  //       });\r\n  //     });\r\n  // } else {\r\n  //   db.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n  //     ...newInfo,\r\n  //   });\r\n  // }\r\n  // // UPDATE LE MOT DE PASSE\r\n  // if (newPassword) {\r\n  //   auth.currentUser\r\n  //     .reauthenticateWithCredential(\r\n  //       firebase.auth.EmailAuthProvider.credential(user.email, currentPassword)\r\n  //     )\r\n  //     .then(() => {\r\n  //       return user.updatePassword(newPassword);\r\n  //     });\r\n  // }\r\n  // // UPDATE LES TORIES, CHARACTERS & COMMENTS SI BESOIN\r\n  // // if()\r\n  // if (newPassword) {\r\n  //   reauthenticate(actualPassword)\r\n  //     .then(() => {\r\n  //       const user = auth.currentUser;\r\n  //       user.updatePassword(newPassword).then(() => {\r\n  //         if (typeof data.image === \"object\") {\r\n  //           storage\r\n  //             .ref(`${auth.currentUser.uid}/${imageName}`)\r\n  //             .put(data.image)\r\n  //             .then(() => {\r\n  //               return storage\r\n  //                 .ref(auth.currentUser.uid)\r\n  //                 .child(imageName)\r\n  //                 .getDownloadURL();\r\n  //             })\r\n  //             .then((url) => {\r\n  //               if (data.username !== username || data.image !== userImage) {\r\n  //                 batch.update(\r\n  //                   db.collection(\"users\").doc(auth.currentUser.uid),\r\n  //                   {\r\n  //                     image: url,\r\n  //                     ...newInfo,\r\n  //                   }\r\n  //                 );\r\n  //                 batch\r\n  //                   .commit()\r\n  //                   .then(() => {\r\n  //                     setOpen(false);\r\n  //                     message.success(\r\n  //                       \"Your profile has been successfully updated\"\r\n  //                     );\r\n  //                   })\r\n  //                   .catch((error) => {\r\n  //                     message.error(error.message);\r\n  //                   });\r\n  //               } else {\r\n  //                 batch.update(\r\n  //                   db.collection(\"users\").doc(auth.currentUser.uid),\r\n  //                   {\r\n  //                     image: url,\r\n  //                     ...newInfo,\r\n  //                   }\r\n  //                 );\r\n  //                 batch\r\n  //                   .commit()\r\n  //                   .then(() => {\r\n  //                     setOpen(false);\r\n  //                     message.success(\r\n  //                       \"Your profile has been successfully updated\"\r\n  //                     );\r\n  //                   })\r\n  //                   .catch((error) => {\r\n  //                     message.error(error.message);\r\n  //                   });\r\n  //               }\r\n  //             });\r\n  //         } else {\r\n  //           if (data.username !== username) {\r\n  //             Promise.all([\r\n  //               userStoriesQuery,\r\n  //               userChaptersQuery,\r\n  //               userCharactersQuery,\r\n  //               userCommentsQuery,\r\n  //             ]).then((res) => {\r\n  //               res[0].forEach((story) => {\r\n  //                 batch.update(db.collection(\"stories\").doc(story.id), {\r\n  //                   authorName: data.username,\r\n  //                 });\r\n  //               });\r\n  //               res[0].forEach((chap) => {\r\n  //                 batch.update(db.collection(\"chapters\").doc(chap.id), {\r\n  //                   authorName: data.username,\r\n  //                 });\r\n  //               });\r\n  //               res[0].forEach((char) => {\r\n  //                 batch.update(db.collection(\"characters\").doc(char.id), {\r\n  //                   authorName: data.username,\r\n  //                 });\r\n  //               });\r\n  //               res[0].forEach((char) => {\r\n  //                 batch.update(db.collection(\"comments\").doc(char.id), {\r\n  //                   username: data.username,\r\n  //                 });\r\n  //               });\r\n  //             });\r\n  //             batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n  //               ...newInfo,\r\n  //             });\r\n  //           } else {\r\n  //             batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n  //               ...newInfo,\r\n  //             });\r\n  //             batch\r\n  //               .commit()\r\n  //               .then(() => {\r\n  //                 setOpen(false);\r\n  //                 message.success(\"Your profile has been successfully updated\");\r\n  //               })\r\n  //               .catch((error) => {\r\n  //                 message.error(error.message);\r\n  //               });\r\n  //           }\r\n  //         }\r\n  //       });\r\n  //     })\r\n  //     .catch((err) => {\r\n  //       message.error(err.message);\r\n  //     });\r\n  // } else {\r\n  //   if (typeof data.image === \"object\") {\r\n  //     storage\r\n  //       .ref(`${auth.currentUser.uid}/${imageName}`)\r\n  //       .put(data.image)\r\n  //       .then(() => {\r\n  //         return storage\r\n  //           .ref(auth.currentUser.uid)\r\n  //           .child(imageName)\r\n  //           .getDownloadURL();\r\n  //       })\r\n  //       .then((url) => {\r\n  //         if (data.username !== username || data.image !== userImage) {\r\n  //           Promise.all([\r\n  //             userStoriesQuery,\r\n  //             userChaptersQuery,\r\n  //             userCharactersQuery,\r\n  //             userCommentsQuery,\r\n  //           ]).then((res) => {\r\n  //             res[0].forEach((story) => {\r\n  //               batch.update(db.collection(\"stories\").doc(story.id), {\r\n  //                 userImage: url,\r\n  //                 authorName: data.username,\r\n  //               });\r\n  //             });\r\n  //             res[1].forEach((chap) => {\r\n  //               batch.update(db.collection(\"chapters\").doc(chap.id), {\r\n  //                 userImage: url,\r\n  //                 authorName: data.username,\r\n  //               });\r\n  //             });\r\n  //             res[2].forEach((char) => {\r\n  //               batch.update(db.collection(\"characters\").doc(char.id), {\r\n  //                 userImage: url,\r\n  //                 authorName: data.username,\r\n  //               });\r\n  //             });\r\n  //             res[3].forEach((char) => {\r\n  //               batch.update(db.collection(\"comments\").doc(char.id), {\r\n  //                 userImage: url,\r\n  //                 username: data.username,\r\n  //               });\r\n  //             });\r\n  //           });\r\n  //           batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n  //             ...newInfo,\r\n  //             image: url,\r\n  //           });\r\n  //           batch\r\n  //             .commit()\r\n  //             .then(() => {\r\n  //               setOpen(false);\r\n  //               message.success(\"Your profile has been successfully updated\");\r\n  //             })\r\n  //             .catch((error) => {\r\n  //               message.error(error.message);\r\n  //             });\r\n  //         } else {\r\n  //           batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n  //             ...newInfo,\r\n  //           });\r\n  //           batch\r\n  //             .commit()\r\n  //             .then(() => {\r\n  //               setOpen(false);\r\n  //               message.success(\"Your profile has been successfully updated\");\r\n  //             })\r\n  //             .catch((error) => {\r\n  //               message.error(error.message);\r\n  //             });\r\n  //         }\r\n  //       });\r\n  //   } else {\r\n  //     if (data.username !== username) {\r\n  //       Promise.all([\r\n  //         userStoriesQuery,\r\n  //         userChaptersQuery,\r\n  //         userCharactersQuery,\r\n  //         userCommentsQuery,\r\n  //       ]).then((res) => {\r\n  //         res[0].forEach((story) => {\r\n  //           batch.update(db.collection(\"stories\").doc(story.id), {\r\n  //             authorName: data.username,\r\n  //           });\r\n  //         });\r\n  //         res[1].forEach((chap) => {\r\n  //           batch.update(db.collection(\"chapters\").doc(chap.id), {\r\n  //             authorName: data.username,\r\n  //           });\r\n  //         });\r\n  //         res[2].forEach((char) => {\r\n  //           batch.update(db.collection(\"characters\").doc(char.id), {\r\n  //             authorName: data.username,\r\n  //           });\r\n  //         });\r\n  //         res[3].forEach((char) => {\r\n  //           batch.update(db.collection(\"comments\").doc(char.id), {\r\n  //             username: data.username,\r\n  //           });\r\n  //         });\r\n  //         batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n  //           ...newInfo,\r\n  //         });\r\n  //         batch\r\n  //           .commit()\r\n  //           .then(() => {\r\n  //             setOpen(false);\r\n  //             message.success(\"Your profile has been successfully updated\");\r\n  //           })\r\n  //           .catch((error) => {\r\n  //             message.error(error.message);\r\n  //           });\r\n  //       });\r\n  //     } else {\r\n  //       batch.update(db.collection(\"users\").doc(auth.currentUser.uid), {\r\n  //         ...newInfo,\r\n  //       });\r\n  //       batch\r\n  //         .commit()\r\n  //         .then(() => {\r\n  //           setOpen(false);\r\n  //           message.success(\"Your profile has been successfully updated\");\r\n  //         })\r\n  //         .catch((error) => {\r\n  //           message.error(error.message);\r\n  //         });\r\n  //     }\r\n  //   }\r\n  // }\r\n};\r\n"]},"metadata":{},"sourceType":"module"}