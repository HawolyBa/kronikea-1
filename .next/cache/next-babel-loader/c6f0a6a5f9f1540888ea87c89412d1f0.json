{"ast":null,"code":"function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport { types } from \"../../utils/constants\";\nimport { message } from \"antd\";\nimport { db, auth, storage } from \"../fbConfig\";\nimport firebase from \"firebase/app\";\nexport const getCharacter = (id, type) => dispatch => {\n  let relArr = [];\n  let storyArr = [];\n  let comments = [];\n  db.collection(\"characters\").doc(id).get().then(doc => {\n    if (doc.exists) {\n      if (type === \"show\") {\n        const relatives = doc.data().relativesArr;\n        let relQueries = [];\n        relatives.forEach(rel => {\n          relQueries.push(db.collection(\"characters\").doc(rel).get());\n        });\n        Promise.all(relQueries).then(res => {\n          res.forEach(char => relArr.push(_objectSpread(_objectSpread({}, char.data()), {}, {\n            id: char.id,\n            relation: doc.data().relatives.find(c => c.character_id === char.id).relation\n          })));\n          const mainQuery = db.collection(\"stories\").where(\"mainCharacters\", \"array-contains\", id).get();\n          const secondaryQuery = db.collection(\"stories\").where(\"secondaryArr\", \"array-contains\", id).get();\n          Promise.all([mainQuery, secondaryQuery]).then(result => {\n            const allStory = result[0].docs.concat(result[1].docs);\n            allStory.forEach(story => {\n              storyArr.push({\n                id: story.id,\n                title: story.data().title,\n                authorId: story.data().authorId,\n                banner: story.data().banner\n              });\n            });\n            db.collection(\"comments\").where(\"characterId\", \"==\", id).onSnapshot(comm => {\n              let userQueries = [];\n              comm.forEach(c => comments.push(_objectSpread(_objectSpread({}, c.data()), {}, {\n                id: c.id\n              })));\n              comments.forEach(comment => {\n                userQueries.push(db.collection(\"users\").doc(comment.id).get());\n              });\n              Promise.all(userQueries).then(res => {\n                comments = comments.map(c => _objectSpread(_objectSpread({}, c), {}, {\n                  userImage: res.find(d => d.id === c.userId) ? res.find(d => d.id === c.userId).data().image : \"\"\n                }));\n                dispatch({\n                  type: types.GET_CHARACTER,\n                  payload: {\n                    character: _objectSpread(_objectSpread({}, doc.data()), {}, {\n                      id: doc.id,\n                      relatives: relArr.filter(r => (auth.currentUser && auth.currentUser.uid) === r.authorId || r.public),\n                      stories: storyArr.filter(r => (auth.currentUser && auth.currentUser.uid) === r.authorId || r.public),\n                      comments\n                    }),\n                    charaExists: true,\n                    loading: false\n                  }\n                });\n              });\n            });\n          });\n        });\n      } else {\n        dispatch({\n          type: types.GET_CHARACTER,\n          payload: {\n            character: _objectSpread(_objectSpread({}, doc.data()), {}, {\n              id: doc.id\n            }),\n            charaExists: true,\n            loading: false\n          }\n        });\n      }\n    } else {\n      dispatch({\n        type: types.GET_CHARACTER,\n        payload: {\n          charaExists: false,\n          loading: false\n        }\n      });\n    }\n  });\n};\nexport const addCharacter = data => dispatch => {\n  dispatch({\n    type: types.ADD_CHARACTER,\n    payload: {\n      loading: true\n    }\n  });\n  let charaId = \"\";\n  db.collection(\"characters\").add(_objectSpread(_objectSpread({}, data), {}, {\n    image: typeof data.image === \"string\" ? data.image : \"\",\n    createdAt: firebase.firestore.FieldValue.serverTimestamp(),\n    likesCount: 0,\n    likes: [],\n    dislikes: []\n  })).then(res => {\n    charaId = res.id;\n    const imageName = `${res.id}${\"_\"}${data.firstname.toLowerCase()}${data.lastname && \"_\"}${data.lastname && data.lastname.toLowerCase()}`;\n\n    if (typeof data.image === \"object\") {\n      storage.ref(`${auth.currentUser.uid}/${imageName}`).put(data.image).then(() => {\n        return storage.ref(auth.currentUser.uid).child(imageName).getDownloadURL();\n      }).then(url => {\n        return db.collection(\"characters\").doc(charaId).update({\n          image: url\n        });\n      }).then(() => {\n        message.success(\"Character added successfully\");\n        dispatch({\n          type: types.ADD_CHARACTER,\n          payload: {\n            message: \"Character added successfully\",\n            characterId: charaId,\n            loading: false\n          }\n        });\n      });\n    } else {\n      message.success(\"Character added successfully\");\n      dispatch({\n        type: types.ADD_CHARACTER,\n        payload: {\n          message: \"Character added successfully\",\n          characterId: charaId,\n          loading: false\n        }\n      });\n    }\n  }).catch(err => {\n    message.error(err.message);\n  });\n};\nexport const editCharacter = (data, id) => dispatch => {\n  dispatch({\n    type: types.EDIT_CHARACTER,\n    payload: {\n      loadingCharacter: true\n    }\n  });\n  const imageName = `${id}${\"_\"}${data.firstname.toLowerCase()}${data.lastname && \"_\"}${data.lastname && data.lastname.toLowerCase()}`;\n\n  if (data.image && typeof data.image === \"object\") {\n    storage.ref(`${auth.currentUser.uid}/${imageName}`).put(data.image).then(() => {\n      return storage.ref(auth.currentUser.uid).child(imageName).getDownloadURL();\n    }).then(url => {\n      return db.collection(\"characters\").doc(id).update(_objectSpread(_objectSpread({}, data), {}, {\n        image: url,\n        relativesArr: data.relatives.map(c => c.character_id)\n      }));\n    }).then(() => {\n      dispatch({\n        type: types.EDIT_CHARACTER,\n        payload: {\n          message: \"Character edited successfully\",\n          loadingCharacter: false\n        }\n      });\n    }).catch(err => {\n      message.error(err.message);\n    });\n  } else {\n    db.collection(\"characters\").doc(id).update(_objectSpread(_objectSpread({}, data), {}, {\n      relativesArr: data.relatives.map(c => c.character_id)\n    })).then(() => {\n      dispatch({\n        type: types.EDIT_CHARACTER,\n        payload: {\n          message: \"Character edited successfully\",\n          loadingCharacter: false\n        }\n      });\n    }).catch(err => {\n      message.error(err.message);\n    });\n  }\n};\nexport const deleteCharacter = (id, firstname, lastname) => dispatch => {\n  dispatch({\n    type: types.DELETE_CHARACTER,\n    payload: {\n      loading: true\n    }\n  });\n  const imageName = `${id}${\"_\"}${firstname.toLowerCase()}${lastname && \"_\"}${lastname && lastname.toLowerCase()}`;\n  const batch = db.batch();\n  db.collection(\"characters\").doc(id).delete().then(() => {\n    if (storage.ref(`${auth.currentUser.uid}/${imageName}`)) {\n      return storage.ref(`${auth.currentUser.uid}/${imageName}`).delete();\n    }\n  }).then(() => {\n    db.collection(\"chapters\").where(\"characters\", \"array-contains\", id).get().then(docs => {\n      docs.forEach(doc => {\n        batch.update(db.collection(\"chapters\").doc(doc.id), {\n          characters: doc.data().characters.filter(c => c !== id)\n        });\n      });\n    }).then(() => {\n      db.collection(\"stories\").where(\"secondaryArr\", \"array-contains\", id).get().then(stories => {\n        stories.forEach(story => {\n          batch.update(db.collection(\"stories\").doc(story.id), {\n            mainCharacters: story.data().mainCharacters.filter(c => c !== id),\n            secondaryArr: story.data().secondaryArr.filter(c => c !== id),\n            secondaryCharacters: story.data().secondaryCharacters.filter(c => c.id !== id)\n          });\n        });\n      }).then(() => {\n        db.collection(\"characters\").where(\"relativesArr\", \"array-contains\", id).get().then(characters => {\n          characters.forEach(char => {\n            batch.update(db.collection(\"characters\").doc(char.id), {\n              relativesArr: char.data().relativesArr.filter(c => c !== id),\n              relatives: char.data().relatives.filter(c => c.character_id !== id)\n            });\n          });\n        }).then(() => {\n          db.collection(\"charactersLikes\").where(\"characterId\", \"==\", id).get().then(likes => {\n            likes.forEach(like => {\n              batch.delete(db.collection(\"charactersLikes\").doc(like.id));\n            });\n            batch.commit().then(() => {\n              dispatch({\n                type: types.DELETE_CHARACTER,\n                payload: {\n                  message: \"Character deleted successfully\",\n                  loading: false,\n                  deleted: true,\n                  charaExists: false\n                }\n              });\n            });\n          });\n        });\n      });\n    });\n  });\n};\nexport const getUserCharacters = userId => dispatch => {\n  db.collection(\"characters\").where(\"authorId\", \"==\", userId).get().then(docs => {\n    let items = [];\n    docs.forEach(doc => {\n      items = [...items, _objectSpread({\n        id: doc.id\n      }, doc.data())];\n    });\n    return items;\n  }).then(items => {\n    dispatch({\n      type: types.GET_USER_CHARACTERS,\n      payload: items\n    });\n  });\n};\nexport const getFavoriteCharacters = () => dispatch => {\n  db.collection(\"charactersLikes\").where(\"senderId\", \"==\", auth.currentUser.uid).get().then(docs => {\n    let favArr = [];\n    docs.forEach(doc => {\n      favArr = [...favArr, doc.data().characterId];\n    });\n    return favArr;\n  }).then(users => {\n    const result = users.map(user => db.collection(\"characters\").doc(user).get());\n    Promise.all(result).then(res => {\n      let favUsers = [];\n      res.forEach(doc => favUsers = [...favUsers, _objectSpread({\n        id: doc.id\n      }, doc.data())]);\n      dispatch({\n        type: types.GET_FAVORITE_CHARACTERS,\n        payload: favUsers\n      });\n    });\n  });\n};\nexport const getCharactersInStory = id => dispatch => {\n  db.collection(\"stories\").doc(id).onSnapshot(doc => {\n    dispatch({\n      type: types.GET_STORY_CHARACTERS,\n      payload: {\n        secondaryCharacters: doc.data().secondaryCharacters,\n        mainArr: doc.data().mainCharacters\n      }\n    });\n  });\n};\nexport const submitCharaterFeedback = info => dispatch => {\n  if (!auth.currentUser.emailVerified) return message.error(\"You need to verify your email first\");\n  if (!info.content) return message.error(\"Content must not be empty\");\n  db.collection(\"comments\").add(_objectSpread(_objectSpread({}, info), {}, {\n    createdAt: firebase.firestore.FieldValue.serverTimestamp()\n  })).then(() => {\n    message.success(\"Comment posted successfully\");\n  }).catch(err => message.error(err.message));\n};","map":{"version":3,"sources":["C:/Users/Utilisateur/Documents/CODE/kronikea-master/redux/actions/charactersActions.js"],"names":["types","message","db","auth","storage","firebase","getCharacter","id","type","dispatch","relArr","storyArr","comments","collection","doc","get","then","exists","relatives","data","relativesArr","relQueries","forEach","rel","push","Promise","all","res","char","relation","find","c","character_id","mainQuery","where","secondaryQuery","result","allStory","docs","concat","story","title","authorId","banner","onSnapshot","comm","userQueries","comment","map","userImage","d","userId","image","GET_CHARACTER","payload","character","filter","r","currentUser","uid","public","stories","charaExists","loading","addCharacter","ADD_CHARACTER","charaId","add","createdAt","firestore","FieldValue","serverTimestamp","likesCount","likes","dislikes","imageName","firstname","toLowerCase","lastname","ref","put","child","getDownloadURL","url","update","success","characterId","catch","err","error","editCharacter","EDIT_CHARACTER","loadingCharacter","deleteCharacter","DELETE_CHARACTER","batch","delete","characters","mainCharacters","secondaryArr","secondaryCharacters","like","commit","deleted","getUserCharacters","items","GET_USER_CHARACTERS","getFavoriteCharacters","favArr","users","user","favUsers","GET_FAVORITE_CHARACTERS","getCharactersInStory","GET_STORY_CHARACTERS","mainArr","submitCharaterFeedback","info","emailVerified","content"],"mappings":"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","sourcesContent":["import { types } from \"../../utils/constants\";\r\nimport { message } from \"antd\";\r\nimport { db, auth, storage } from \"../fbConfig\";\r\nimport firebase from \"firebase/app\";\r\n\r\nexport const getCharacter = (id, type) => (dispatch) => {\r\n  let relArr = [];\r\n  let storyArr = [];\r\n  let comments = [];\r\n  db.collection(\"characters\")\r\n    .doc(id)\r\n    .get()\r\n    .then((doc) => {\r\n      if (doc.exists) {\r\n        if (type === \"show\") {\r\n          const relatives = doc.data().relativesArr;\r\n          let relQueries = [];\r\n          relatives.forEach((rel) => {\r\n            relQueries.push(db.collection(\"characters\").doc(rel).get());\r\n          });\r\n          Promise.all(relQueries).then((res) => {\r\n            res.forEach((char) =>\r\n              relArr.push({\r\n                ...char.data(),\r\n                id: char.id,\r\n                relation: doc\r\n                  .data()\r\n                  .relatives.find((c) => c.character_id === char.id).relation,\r\n              })\r\n            );\r\n\r\n            const mainQuery = db\r\n              .collection(\"stories\")\r\n              .where(\"mainCharacters\", \"array-contains\", id)\r\n              .get();\r\n\r\n            const secondaryQuery = db\r\n              .collection(\"stories\")\r\n              .where(\"secondaryArr\", \"array-contains\", id)\r\n              .get();\r\n\r\n            Promise.all([mainQuery, secondaryQuery]).then((result) => {\r\n              const allStory = result[0].docs.concat(result[1].docs);\r\n              allStory.forEach((story) => {\r\n                storyArr.push({\r\n                  id: story.id,\r\n                  title: story.data().title,\r\n                  authorId: story.data().authorId,\r\n                  banner: story.data().banner,\r\n                });\r\n              });\r\n              db.collection(\"comments\")\r\n                .where(\"characterId\", \"==\", id)\r\n                .onSnapshot((comm) => {\r\n                  let userQueries = [];\r\n                  comm.forEach((c) => comments.push({ ...c.data(), id: c.id }));\r\n                  comments.forEach((comment) => {\r\n                    userQueries.push(\r\n                      db.collection(\"users\").doc(comment.id).get()\r\n                    );\r\n                  });\r\n                  Promise.all(userQueries).then((res) => {\r\n                    comments = comments.map((c) => ({\r\n                      ...c,\r\n                      userImage: res.find((d) => d.id === c.userId)\r\n                        ? res.find((d) => d.id === c.userId).data().image\r\n                        : \"\",\r\n                    }));\r\n                    dispatch({\r\n                      type: types.GET_CHARACTER,\r\n                      payload: {\r\n                        character: {\r\n                          ...doc.data(),\r\n                          id: doc.id,\r\n                          relatives: relArr.filter(\r\n                            (r) =>\r\n                              (auth.currentUser && auth.currentUser.uid) ===\r\n                                r.authorId || r.public\r\n                          ),\r\n                          stories: storyArr.filter(\r\n                            (r) =>\r\n                              (auth.currentUser && auth.currentUser.uid) ===\r\n                                r.authorId || r.public\r\n                          ),\r\n                          comments,\r\n                        },\r\n                        charaExists: true,\r\n                        loading: false,\r\n                      },\r\n                    });\r\n                  });\r\n                });\r\n            });\r\n          });\r\n        } else {\r\n          dispatch({\r\n            type: types.GET_CHARACTER,\r\n            payload: {\r\n              character: { ...doc.data(), id: doc.id },\r\n              charaExists: true,\r\n              loading: false,\r\n            },\r\n          });\r\n        }\r\n      } else {\r\n        dispatch({\r\n          type: types.GET_CHARACTER,\r\n          payload: {\r\n            charaExists: false,\r\n            loading: false,\r\n          },\r\n        });\r\n      }\r\n    });\r\n};\r\n\r\nexport const addCharacter = (data) => (dispatch) => {\r\n  dispatch({ type: types.ADD_CHARACTER, payload: { loading: true } });\r\n\r\n  let charaId = \"\";\r\n  db.collection(\"characters\")\r\n    .add({\r\n      ...data,\r\n      image: typeof data.image === \"string\" ? data.image : \"\",\r\n      createdAt: firebase.firestore.FieldValue.serverTimestamp(),\r\n      likesCount: 0,\r\n      likes: [],\r\n      dislikes: [],\r\n    })\r\n    .then((res) => {\r\n      charaId = res.id;\r\n      const imageName = `${res.id}${\"_\"}${data.firstname.toLowerCase()}${\r\n        data.lastname && \"_\"\r\n      }${data.lastname && data.lastname.toLowerCase()}`;\r\n\r\n      if (typeof data.image === \"object\") {\r\n        storage\r\n          .ref(`${auth.currentUser.uid}/${imageName}`)\r\n          .put(data.image)\r\n          .then(() => {\r\n            return storage\r\n              .ref(auth.currentUser.uid)\r\n              .child(imageName)\r\n              .getDownloadURL();\r\n          })\r\n          .then((url) => {\r\n            return db\r\n              .collection(\"characters\")\r\n              .doc(charaId)\r\n              .update({ image: url });\r\n          })\r\n          .then(() => {\r\n            message.success(\"Character added successfully\");\r\n            dispatch({\r\n              type: types.ADD_CHARACTER,\r\n              payload: {\r\n                message: \"Character added successfully\",\r\n                characterId: charaId,\r\n                loading: false,\r\n              },\r\n            });\r\n          });\r\n      } else {\r\n        message.success(\"Character added successfully\");\r\n        dispatch({\r\n          type: types.ADD_CHARACTER,\r\n          payload: {\r\n            message: \"Character added successfully\",\r\n            characterId: charaId,\r\n            loading: false,\r\n          },\r\n        });\r\n      }\r\n    })\r\n    .catch((err) => {\r\n      message.error(err.message);\r\n    });\r\n};\r\n\r\nexport const editCharacter = (data, id) => (dispatch) => {\r\n  dispatch({ type: types.EDIT_CHARACTER, payload: { loadingCharacter: true } });\r\n\r\n  const imageName = `${id}${\"_\"}${data.firstname.toLowerCase()}${\r\n    data.lastname && \"_\"\r\n  }${data.lastname && data.lastname.toLowerCase()}`;\r\n\r\n  if (data.image && typeof data.image === \"object\") {\r\n    storage\r\n      .ref(`${auth.currentUser.uid}/${imageName}`)\r\n      .put(data.image)\r\n      .then(() => {\r\n        return storage\r\n          .ref(auth.currentUser.uid)\r\n          .child(imageName)\r\n          .getDownloadURL();\r\n      })\r\n      .then((url) => {\r\n        return db\r\n          .collection(\"characters\")\r\n          .doc(id)\r\n          .update({\r\n            ...data,\r\n            image: url,\r\n            relativesArr: data.relatives.map((c) => c.character_id),\r\n          });\r\n      })\r\n      .then(() => {\r\n        dispatch({\r\n          type: types.EDIT_CHARACTER,\r\n          payload: {\r\n            message: \"Character edited successfully\",\r\n            loadingCharacter: false,\r\n          },\r\n        });\r\n      })\r\n      .catch((err) => {\r\n        message.error(err.message);\r\n      });\r\n  } else {\r\n    db.collection(\"characters\")\r\n      .doc(id)\r\n      .update({\r\n        ...data,\r\n        relativesArr: data.relatives.map((c) => c.character_id),\r\n      })\r\n      .then(() => {\r\n        dispatch({\r\n          type: types.EDIT_CHARACTER,\r\n          payload: {\r\n            message: \"Character edited successfully\",\r\n            loadingCharacter: false,\r\n          },\r\n        });\r\n      })\r\n      .catch((err) => {\r\n        message.error(err.message);\r\n      });\r\n  }\r\n};\r\n\r\nexport const deleteCharacter = (id, firstname, lastname) => (dispatch) => {\r\n  dispatch({ type: types.DELETE_CHARACTER, payload: { loading: true } });\r\n  const imageName = `${id}${\"_\"}${firstname.toLowerCase()}${lastname && \"_\"}${\r\n    lastname && lastname.toLowerCase()\r\n  }`;\r\n  const batch = db.batch();\r\n  db.collection(\"characters\")\r\n    .doc(id)\r\n    .delete()\r\n    .then(() => {\r\n      if (storage.ref(`${auth.currentUser.uid}/${imageName}`)) {\r\n        return storage.ref(`${auth.currentUser.uid}/${imageName}`).delete();\r\n      }\r\n    })\r\n    .then(() => {\r\n      db.collection(\"chapters\")\r\n        .where(\"characters\", \"array-contains\", id)\r\n        .get()\r\n        .then((docs) => {\r\n          docs.forEach((doc) => {\r\n            batch.update(db.collection(\"chapters\").doc(doc.id), {\r\n              characters: doc.data().characters.filter((c) => c !== id),\r\n            });\r\n          });\r\n        })\r\n        .then(() => {\r\n          db.collection(\"stories\")\r\n            .where(\"secondaryArr\", \"array-contains\", id)\r\n            .get()\r\n            .then((stories) => {\r\n              stories.forEach((story) => {\r\n                batch.update(db.collection(\"stories\").doc(story.id), {\r\n                  mainCharacters: story\r\n                    .data()\r\n                    .mainCharacters.filter((c) => c !== id),\r\n                  secondaryArr: story\r\n                    .data()\r\n                    .secondaryArr.filter((c) => c !== id),\r\n                  secondaryCharacters: story\r\n                    .data()\r\n                    .secondaryCharacters.filter((c) => c.id !== id),\r\n                });\r\n              });\r\n            })\r\n            .then(() => {\r\n              db.collection(\"characters\")\r\n                .where(\"relativesArr\", \"array-contains\", id)\r\n                .get()\r\n                .then((characters) => {\r\n                  characters.forEach((char) => {\r\n                    batch.update(db.collection(\"characters\").doc(char.id), {\r\n                      relativesArr: char\r\n                        .data()\r\n                        .relativesArr.filter((c) => c !== id),\r\n                      relatives: char\r\n                        .data()\r\n                        .relatives.filter((c) => c.character_id !== id),\r\n                    });\r\n                  });\r\n                })\r\n                .then(() => {\r\n                  db.collection(\"charactersLikes\")\r\n                    .where(\"characterId\", \"==\", id)\r\n                    .get()\r\n                    .then((likes) => {\r\n                      likes.forEach((like) => {\r\n                        batch.delete(\r\n                          db.collection(\"charactersLikes\").doc(like.id)\r\n                        );\r\n                      });\r\n                      batch.commit().then(() => {\r\n                        dispatch({\r\n                          type: types.DELETE_CHARACTER,\r\n                          payload: {\r\n                            message: \"Character deleted successfully\",\r\n                            loading: false,\r\n                            deleted: true,\r\n                            charaExists: false,\r\n                          },\r\n                        });\r\n                      });\r\n                    });\r\n                });\r\n            });\r\n        });\r\n    });\r\n};\r\n\r\nexport const getUserCharacters = (userId) => (dispatch) => {\r\n  db.collection(\"characters\")\r\n    .where(\"authorId\", \"==\", userId)\r\n    .get()\r\n    .then((docs) => {\r\n      let items = [];\r\n      docs.forEach((doc) => {\r\n        items = [...items, { id: doc.id, ...doc.data() }];\r\n      });\r\n      return items;\r\n    })\r\n    .then((items) => {\r\n      dispatch({ type: types.GET_USER_CHARACTERS, payload: items });\r\n    });\r\n};\r\n\r\nexport const getFavoriteCharacters = () => (dispatch) => {\r\n  db.collection(\"charactersLikes\")\r\n    .where(\"senderId\", \"==\", auth.currentUser.uid)\r\n    .get()\r\n    .then((docs) => {\r\n      let favArr = [];\r\n      docs.forEach((doc) => {\r\n        favArr = [...favArr, doc.data().characterId];\r\n      });\r\n      return favArr;\r\n    })\r\n    .then((users) => {\r\n      const result = users.map((user) =>\r\n        db.collection(\"characters\").doc(user).get()\r\n      );\r\n      Promise.all(result).then((res) => {\r\n        let favUsers = [];\r\n        res.forEach(\r\n          (doc) => (favUsers = [...favUsers, { id: doc.id, ...doc.data() }])\r\n        );\r\n        dispatch({\r\n          type: types.GET_FAVORITE_CHARACTERS,\r\n          payload: favUsers,\r\n        });\r\n      });\r\n    });\r\n};\r\n\r\nexport const getCharactersInStory = (id) => (dispatch) => {\r\n  db.collection(\"stories\")\r\n    .doc(id)\r\n    .onSnapshot((doc) => {\r\n      dispatch({\r\n        type: types.GET_STORY_CHARACTERS,\r\n        payload: {\r\n          secondaryCharacters: doc.data().secondaryCharacters,\r\n          mainArr: doc.data().mainCharacters,\r\n        },\r\n      });\r\n    });\r\n};\r\n\r\nexport const submitCharaterFeedback = (info) => (dispatch) => {\r\n  if (!auth.currentUser.emailVerified)\r\n    return message.error(\"You need to verify your email first\");\r\n  if (!info.content) return message.error(\"Content must not be empty\");\r\n\r\n  db.collection(\"comments\")\r\n    .add({\r\n      ...info,\r\n      createdAt: firebase.firestore.FieldValue.serverTimestamp(),\r\n    })\r\n    .then(() => {\r\n      message.success(\"Comment posted successfully\");\r\n    })\r\n    .catch((err) => message.error(err.message));\r\n};\r\n"]},"metadata":{},"sourceType":"module"}